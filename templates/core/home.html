{% extends 'core/base.html' %}
{% block content %}
<style>
  /* Enhanced CSS Variables */
  :root {
    --home-primary: #3b82f6;
    --home-secondary: #2563eb;
    --home-success: #10b981;
    --home-warning: #f59e0b;
    --home-danger: #ef4444;
    --home-info: #3b82f6;
    --home-light: #f8fafc;
    --home-dark: #1e293b;
    --home-gradient: linear-gradient(135deg, var(--home-primary), var(--home-secondary));
    --home-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    --home-shadow-lg: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
  }

  /* Enhanced Body */
  body {
    background: linear-gradient(135deg, #f5e6d3 0%, #faf5f0 100%);
    min-height: 100vh;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
  }

  /* Add spacing below sticky navbar */
  .container {
    padding-top: 1rem;
  }

  /* Enhanced Hero Section */
  .hero {
    background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(255,255,255,0.9) 100%);
    backdrop-filter: blur(20px);
    border-radius: 16px;
    border: 1px solid rgba(255,255,255,0.2);
    box-shadow: var(--home-shadow-lg);
    position: relative;
    overflow: hidden;
    margin-top: 0.5rem;
    margin-bottom: 1.5rem;
  }
  
  .hero::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: var(--home-gradient);
  }
  
  .hero .title {
    font-weight: 700;
    font-size: 1.5rem;
    background: var(--home-gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    letter-spacing: -0.025em;
  }

  /* Enhanced KPI Cards */
  .kpi-card {
    background: rgba(255,255,255,0.95);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255,255,255,0.2);
    border-radius: 12px;
    box-shadow: var(--home-shadow);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }
  
  .kpi-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: var(--home-gradient);
    opacity: 0;
    transition: opacity 0.3s ease;
  }
  
  .kpi-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--home-shadow-lg);
  }
  
  .kpi-card:hover::before {
    opacity: 1;
  }
  
  .kpi-pill {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.25rem 0.75rem;
    border-radius: 50px;
    font-size: 0.75rem;
    font-weight: 600;
    background: var(--home-gradient);
    color: white;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
  }
  
  .kpi-value {
    font-size: 1.75rem;
    font-weight: 800;
    background: var(--home-gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    line-height: 1;
  }
  
  .kpi-change {
    font-size: 0.75rem;
    font-weight: 600;
    padding: 0.2rem 0.5rem;
    border-radius: 50px;
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
  }
  
  .kpi-change.positive {
    background: rgba(16, 185, 129, 0.1);
    color: var(--home-success);
  }
  
  .kpi-change.negative {
    background: rgba(239, 68, 68, 0.1);
    color: var(--home-danger);
  }

  /* Enhanced Panels */
  .panel {
    background: rgba(255,255,255,0.95);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255,255,255,0.2);
    border-radius: 12px;
    box-shadow: var(--home-shadow);
    transition: all 0.3s ease;
  }
  
  .panel:hover {
    transform: translateY(-2px);
    box-shadow: var(--home-shadow-lg);
  }
  
  .panel-title {
    font-weight: 700;
    font-size: 1rem;
    color: var(--home-dark);
    margin-bottom: 0.75rem;
  }

  /* Enhanced Buttons */
  .btn-honey {
    background: linear-gradient(135deg, #3b82f6, #2563eb);
    border: none;
    color: white;
    font-weight: 700;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
    transition: all 0.3s ease;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-size: 0.75rem;
  }
  
  .btn-honey:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(245, 158, 11, 0.4);
    background: linear-gradient(135deg, #2563eb, #1d4ed8);
  }
  
  .btn-outline-primary {
    border: 2px solid var(--home-primary);
    color: var(--home-primary);
    font-weight: 600;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    transition: all 0.3s ease;
    font-size: 0.75rem;
  }
  
  .btn-outline-primary:hover {
    background: var(--home-primary);
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
  }

  /* Enhanced Tables */
  .table {
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
  }
  
  .table thead th {
    background: var(--home-gradient);
    color: white;
    font-weight: 700;
    font-size: 0.875rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border: none;
    padding: 1rem;
  }
  
  .table tbody td {
    padding: 1rem;
    border-color: rgba(0,0,0,0.05);
    vertical-align: middle;
  }
  
  .table tbody tr:hover {
    background: rgba(59, 130, 246, 0.05);
  }

  /* Enhanced Role Badge */
  .role-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.25rem;
    border-radius: 50px;
    font-weight: 700;
    font-size: 0.875rem;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }
  
  .role-admin {
    background: linear-gradient(135deg, #3b82f6, #1d4ed8);
    color: white;
  }
  
  .role-cashier {
    background: linear-gradient(135deg, #10b981, #059669);
    color: white;
  }

  /* Enhanced Icon Circle */
  .ic {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background: var(--home-gradient);
    color: white;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
  }

  /* Chart Container */
  .chart-container {
    position: relative;
    height: 200px;
    background: rgba(255,255,255,0.5);
    border-radius: 8px;
    padding: 0.75rem;
  }

  /* Animations */
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  .kpi-card, .panel {
    animation: fadeInUp 0.6s ease-out;
  }
  
  .kpi-card:nth-child(1) { animation-delay: 0.1s; }
  .kpi-card:nth-child(2) { animation-delay: 0.2s; }
  .kpi-card:nth-child(3) { animation-delay: 0.3s; }
</style>

<!-- Hero / Header -->
<div class="hero p-3 p-md-4">
  <div class="d-flex flex-wrap align-items-center justify-content-between gap-3">
    <div>
      <h1 class="h4 title mb-1">Alvarez Bakery â€” POS Dashboard</h1>
      <div class="text-secondary">Quick overview, shortcuts, and todayâ€™s performance.</div>
    </div>

    <div class="d-flex align-items-center gap-2">
      <a href="/pos/" class="btn btn-honey">
        <!-- cart icon -->
        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" class="me-1">
          <path d="M7 4h-2l-1 2h2l2.68 9.39A2 2 0 0 0 10.6 17h6.8a2 2 0 0 0 1.93-1.52L22 7H6.42l-.5-2ZM7 20a2 2 0 1 0 0-4 2 2 0 0 0 0 4Zm10 0a2 2 0 1 0-.001-3.999A2 2 0 0 0 17 20Z"/>
        </svg>
        Open POS
      </a>
      {% if request.user.is_staff %}
      <a href="/products/" class="btn btn-outline-primary">Manage Products</a>
      {% endif %}
    </div>
  </div>
</div>

<!-- Enhanced KPIs -->
<div class="row g-3 mb-3">
  <div class="col-12 col-md-4">
    <div class="kpi-card p-3">
      <div class="d-flex align-items-center justify-content-between mb-2">
        <div class="kpi-pill">
          <span class="ic">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
            </svg>
          </span>
          Today's Revenue
        </div>
        <span class="text-muted small fw-bold">â‚±</span>
      </div>
      <div class="kpi-value mb-1">â‚±{{ kpi_today_sales|default:"0.00" }}</div>
      {% with growth_str=kpi_today_growth|default:"+0.0%" %}
      <div class="kpi-change {% if growth_str|first == '+' %}positive{% else %}negative{% endif %}">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
          {% if growth_str|first == '+' %}
          <path d="M7 14l5-5 5 5z"/>
          {% else %}
          <path d="M7 10l5 5 5-5z"/>
          {% endif %}
        </svg>
        {{ growth_str }} vs yesterday
      </div>
      {% endwith %}
    </div>
  </div>
  <div class="col-12 col-md-4">
    <div class="kpi-card p-3">
      <div class="d-flex align-items-center justify-content-between mb-2">
        <div class="kpi-pill">
          <span class="ic">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
              <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
            </svg>
          </span>
          Orders Today
        </div>
        <span class="text-muted small fw-bold">Count</span>
      </div>
      <div class="kpi-value mb-1">{{ kpi_today_orders|default:"0" }}</div>
      <div class="text-muted small">
        <strong>Avg ticket:</strong> â‚±{{ kpi_avg_ticket|default:"0.00" }}
      </div>
    </div>
  </div>
  <div class="col-12 col-md-4">
    <div class="kpi-card p-3">
      <div class="d-flex align-items-center justify-content-between mb-2">
        <div class="kpi-pill">
          <span class="ic">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
            </svg>
          </span>
          Active Products
        </div>
        <span class="text-muted small fw-bold">Items</span>
      </div>
      <div class="kpi-value mb-1">{{ kpi_low_stock|default:"0" }}</div>
      <div class="text-muted small">
        <strong>Products in catalog</strong>
      </div>
    </div>
  </div>
</div>

<!-- Main content -->
<div class="row g-3">
  <!-- Left column: Quick Actions + Role + Top Sellers -->
  <div class="col-lg-5">
    <div class="panel p-3 mb-3">
      <div class="d-flex align-items-center justify-content-between mb-2">
        <h5 class="mb-0">Quick Actions</h5>
      </div>
      <div class="d-grid gap-2">
        <a class="btn btn-honey" href="/pos/">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" class="me-2">
            <path d="M7 4h-2l-1 2h2l2.68 9.39A2 2 0 0 0 10.6 17h6.8a2 2 0 0 0 1.93-1.52L22 7H6.42l-.5-2Z"/>
          </svg>
          Open POS
        </a>
        {% if request.user.is_staff %}
        <div class="d-flex gap-2">
          <a class="btn btn-outline-primary flex-fill" href="/products/">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" class="me-2"><path d="M3 3h18v2H3zM4 7h16v12H4z"/></svg>
            Manage Products
          </a>
          <a class="btn btn-outline-secondary flex-fill" href="/forecast/">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" class="me-2"><path d="M3 13h4v8H3zM10 3h4v18h-4zM17 9h4v12h-4z"/></svg>
            Forecast
          </a>
        </div>
        <a class="btn btn-outline-dark" href="/reports/">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" class="me-2"><path d="M4 4h16v2H4zM6 8h12v10H6zM4 20h16v2H4z"/></svg>
          Reports
        </a>
        {% endif %}
      </div>
    </div>

    <div class="panel p-3 mb-3">
      <h5 class="mb-2">Your Role</h5>
      {% if request.user.is_staff %}
        <span class="role-badge role-admin">
          <!-- shield icon -->
          <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2 4 5v6c0 5.55 3.84 10.74 8 12 4.16-1.26 8-6.45 8-12V5l-8-3z"/></svg>
          Admin (Owner)
        </span>
        <div class="text-muted small mt-2">Full access â€” products, POS, forecasts, and reports.</div>
      {% else %}
        <span class="role-badge role-cashier">
          <!-- user icon -->
          <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5Zm0 2c-4.33 0-8 2.17-8 5v1h16v-1c0-2.83-3.67-5-8-5Z"/></svg>
          Cashier (Staff)
        </span>
        <div class="text-muted small mt-2">POS access only â€” process sales and print receipts.</div>
      {% endif %}
    </div>

    <div class="panel p-3">
      <div class="d-flex align-items-center justify-content-between mb-2">
        <h5 class="mb-0">Top Sellers</h5>
        {% if request.user.is_staff %}<a href="/reports/" class="small text-decoration-none">View all</a>{% endif %}
      </div>
      <div class="table-responsive">
        <table class="table align-middle mb-0">
          <thead>
            <tr>
              <th>Product</th>
              <th class="text-end">Qty</th>
              <th class="text-end">Revenue</th>
            </tr>
          </thead>
          <tbody>
            {% if top_products %}
              {% for p in top_products %}
              <tr>
                <td>{{ p.product }}</td>
                <td class="text-end">{{ p.qty }}</td>
                <td class="text-end">PHP {{ p.revenue }}</td>
              </tr>
              {% endfor %}
            {% else %}
              <tr><td colspan="3" class="text-muted">No data yet. Make a few sales in POS.</td></tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Right column: Sales chart + Recent Transactions -->
  <div class="col-lg-7">
    <div class="panel p-3 mb-3">
      <div class="d-flex align-items-center justify-content-between mb-2">
        <h5 class="panel-title mb-0">ðŸ“ˆ Revenue Trend & Quantity</h5>
        {% if request.user.is_staff %}
        <a href="/forecast/" class="btn btn-sm btn-outline-primary">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor" class="me-1">
            <path d="M3 13h4v8H3zM10 3h4v18h-4zM17 9h4v12h-4z"/>
          </svg>
          Forecast
        </a>
        {% endif %}
      </div>
      <div class="d-flex align-items-center justify-content-center mb-2 gap-3">
        <div class="d-flex align-items-center gap-2">
          <span style="width: 12px; height: 12px; border-radius: 50%; background: #0d6efd; display: inline-block;"></span>
          <span class="small text-muted">Revenue</span>
        </div>
        <div class="d-flex align-items-center gap-2">
          <span style="width: 12px; height: 12px; border-radius: 50%; background: #20c997; display: inline-block;"></span>
          <span class="small text-muted">Quantity</span>
        </div>
      </div>
      <div class="chart-container">
        <canvas id="sales7Chart" height="120"></canvas>
      </div>
    </div>

    <div class="panel p-3">
      <div class="d-flex align-items-center justify-content-between mb-2">
        <h5 class="mb-0">Recent Transactions</h5>
        <a href="/reports/" class="small text-decoration-none">Go to reports</a>
      </div>
      <div class="table-responsive">
        <table class="table align-middle mb-0">
          <thead>
            <tr>
              <th>Receipt #</th>
              <th>Time</th>
              <th class="text-end">Items</th>
              <th class="text-end">Total</th>
            </tr>
          </thead>
          <tbody>
            {% if recent_sales %}
              {% for s in recent_sales %}
              <tr>
                <td><span class="badge text-bg-light">#{{ s.id }}</span></td>
                <td>{{ s.created_at }}</td>
                <td class="text-end">{{ s.item_count }}</td>
                <td class="text-end">PHP {{ s.total_amount }}</td>
              </tr>
              {% endfor %}
            {% else %}
              <tr><td colspan="4" class="text-muted">No transactions yet today.</td></tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

{% comment %}
  The chart will use server-provided arrays if present:
  - last7_labels: JSON list of 7 day labels (e.g., ["Mon","Tue",...])
  - last7_values: JSON list of 7 numbers (sales totals)
  - last7_quantities: JSON list of 7 numbers (quantity sold)
  If not provided, it falls back to a simple demo dataset.
{% endcomment %}

<script>
  function initRevenueQuantityChart() {
    const ctx = document.getElementById('sales7Chart');
    if (!ctx) {
      setTimeout(initRevenueQuantityChart, 100);
      return;
    }
    
    if (typeof Chart === 'undefined') {
      setTimeout(initRevenueQuantityChart, 100);
      return;
    }

    // Get real data from backend (monthly data)
    let labels, values, quantities;
    
    try {
      // Data is already JSON serialized from backend
      labels = {{ last7_labels|safe }};
      values = {{ last7_values|safe }};
      quantities = {{ last7_quantities|safe }};
      
      // Ensure they are arrays
      if (!Array.isArray(labels)) labels = [];
      if (!Array.isArray(values)) values = [];
      if (!Array.isArray(quantities)) quantities = [];
    } catch (e) {
      console.warn('Error parsing chart data:', e);
      labels = [];
      values = [];
      quantities = [];
    }

    // Generate month labels if no data available
    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    if (labels.length === 0) {
      // Generate last 7 months labels
      const today = new Date();
      for (let i = 6; i >= 0; i--) {
        const date = new Date(today.getFullYear(), today.getMonth() - i, 1);
        const monthName = monthNames[date.getMonth()];
        labels.push(`${monthName} ${date.getFullYear()}`);
      }
    }
    
    // Ensure labels are strings
    const chartLabels = labels.map(l => String(l || ''));
    
    // Ensure values and quantities are numbers
    const ensureNumericArray = (arr) => {
      if (!Array.isArray(arr) || arr.length === 0) {
        return [];
      }
      return arr.map(v => {
        const num = parseFloat(v) || 0;
        return isNaN(num) ? 0 : num;
      });
    };
    
    const chartValues = ensureNumericArray(values);
    const chartQuantities = ensureNumericArray(quantities);
    
    // Ensure all arrays have the same length (pad with zeros/empty strings)
    const maxLength = Math.max(
      chartLabels.length || 0,
      chartValues.length || 0,
      chartQuantities.length || 0
    );
    
    // Pad arrays if needed to match length
    while (chartLabels.length < maxLength) {
      const date = new Date();
      date.setMonth(date.getMonth() - (maxLength - chartLabels.length));
      const monthName = monthNames[date.getMonth()];
      chartLabels.push(`${monthName} ${date.getFullYear()}`);
    }
    while (chartValues.length < maxLength) chartValues.push(0);
    while (chartQuantities.length < maxLength) chartQuantities.push(0);

    const pesoFmt = new Intl.NumberFormat('en-PH', { style: 'currency', currency: 'PHP' });
    const grad = ctx.getContext('2d').createLinearGradient(0, 0, 0, 200);
    grad.addColorStop(0, 'rgba(13, 110, 253, 0.2)');
    grad.addColorStop(1, 'rgba(13, 110, 253, 0)');

    // Enhanced chart with dual y-axis for revenue and quantity
    new Chart(ctx, {
      type: 'line',
      data: {
        labels: chartLabels,
        datasets: [{
          label: 'Revenue',
          data: chartValues,
          borderColor: '#0d6efd',
          backgroundColor: grad,
          fill: true,
          borderWidth: 2,
          tension: 0.35,
          pointRadius: 0,
          pointHoverRadius: 4,
          yAxisID: 'y'
        }, {
          label: 'Quantity',
          data: chartQuantities,
          borderColor: '#20c997',
          backgroundColor: 'rgba(32, 201, 151, 0.1)',
          fill: false,
          borderWidth: 2,
          tension: 0.25,
          pointRadius: 0,
          pointHoverRadius: 4,
          yAxisID: 'y1'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: 'index', intersect: false },
        plugins: { 
          legend: { display: false },
          tooltip: {
            backgroundColor: 'rgba(0,0,0,0.8)',
            titleColor: '#fff',
            bodyColor: '#fff',
            borderColor: '#0d6efd',
            borderWidth: 1,
            cornerRadius: 8,
            padding: 12,
            displayColors: true,
            callbacks: {
              label: function(context) {
                if (context.dataset.label === 'Revenue') {
                  return `Revenue: ${pesoFmt.format(context.parsed.y || 0)}`;
                } else {
                  return `Quantity: ${context.parsed.y || 0} units`;
                }
              }
            }
          }
        },
        scales: {
          x: {
            type: 'category',
            grid: { display: false },
            ticks: {
              font: { size: 11, weight: '600' },
              color: '#6b7280',
              maxRotation: 45,
              minRotation: 0
            }
          },
          y: {
            type: 'linear',
            display: true,
            position: 'left',
            beginAtZero: true,
            min: 0,
            suggestedMax: (chartValues.length > 0 && Math.max(...chartValues) === 0) ? 1000 : undefined,
            grid: {
              color: 'rgba(0,0,0,0.05)',
              drawBorder: false
            },
            ticks: {
              font: { size: 11, weight: '600' },
              color: '#4b5563',
              callback: function(value) {
                return pesoFmt.format(value).replace('PHP', 'â‚±');
              }
            }
          },
          y1: {
            type: 'linear',
            display: true,
            position: 'right',
            beginAtZero: true,
            min: 0,
            suggestedMax: (chartQuantities.length > 0 && Math.max(...chartQuantities) === 0) ? 10 : undefined,
            grid: {
              drawOnChartArea: false
            },
            ticks: {
              font: { size: 11, weight: '600' },
              color: '#4b5563',
              callback: function(value) {
                return value;
              }
            }
          }
        },
        animation: {
          duration: 2000,
          easing: 'easeInOutQuart'
        }
      }
    });
  }
  
  // Initialize chart on page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initRevenueQuantityChart);
  } else {
    initRevenueQuantityChart();
  }
  
  // Fallback initialization after a short delay
  setTimeout(initRevenueQuantityChart, 500);
</script>
{% endblock %}
