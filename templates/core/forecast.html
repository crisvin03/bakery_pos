{% extends 'core/base.html' %}
{% block content %}

<style>
  :root{
    --ab-border: rgba(16,24,40,.08);
    --ab-soft: rgba(13,110,253,.08);
    --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    --warning-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    --info-gradient: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
  }

  /* Professional Card Design */
  .kpi-card{
    border-radius: 20px;
    border: 1px solid var(--ab-border);
    box-shadow: 0 20px 40px rgba(16,24,40,.08);
    background: linear-gradient(135deg, #fff 0%, #f8fafc 100%);
    backdrop-filter: blur(20px);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
    padding: 1rem;
  }

  .kpi-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: var(--primary-gradient);
  }

  .kpi-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 25px 50px rgba(16,24,40,.12);
  }

  .panel-title{
    font-weight: 800;
    letter-spacing: -0.025em;
    background: var(--primary-gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .muted{color:#6b7280}
  .num{font-variant-numeric:tabular-nums;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}

  /* Enhanced Pills */
  .pill{
    display: inline-flex;
    align-items: center;
    gap: .4rem;
    border: 1px solid var(--ab-border);
    border-radius: 999px;
    padding: .5rem 1rem;
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(10px);
    transition: all 0.2s ease;
    box-shadow: 0 4px 12px rgba(0,0,0,.05);
  }

  .pill:hover {
    transform: translateY(-1px);
    box-shadow: 0 8px 20px rgba(0,0,0,.1);
  }

  .pill .dot{
    width: 12px;
    height: 12px;
    border-radius: 50%;
    box-shadow: 0 2px 4px rgba(0,0,0,.2);
  }
  .dot-blue{background: linear-gradient(135deg, #0d6efd, #4facfe)}
  .dot-green{background: linear-gradient(135deg, #20c997, #4facfe)}

  /* Enhanced Mini KPIs */
  .mini-kpis{
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1rem;
  }

  .mini-kpis .k{
    border: 1px solid var(--ab-border);
    border-radius: 16px;
    padding: 1.25rem 1.5rem;
    background: linear-gradient(135deg, #fff 0%, #f8fafc 100%);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }

  .mini-kpis .k::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: var(--primary-gradient);
  }

  .mini-kpis .k:hover {
    transform: translateY(-3px);
    box-shadow: 0 15px 30px rgba(0,0,0,.1);
  }

  .mini-kpis .k .label{
    font-size: .85rem;
    color: #6b7280;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .mini-kpis .k .value{
    font-size: 1.4rem;
    font-weight: 800;
    margin-top: 0.5rem;
    background: var(--primary-gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  /* Enhanced Table */
  .table thead th{
    color: #6b7280;
    border-bottom-color: var(--ab-border);
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    position: sticky;
    top: 0;
    z-index: 2;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-size: 0.8rem;
  }

  .table-hover>tbody>tr:hover>*{
    background: linear-gradient(135deg, #fafbff 0%, #f1f5f9 100%);
    transform: scale(1.02);
    transition: all 0.2s ease;
  }

  /* Enhanced Empty State */
  .empty{
    text-align: center;
    padding: 3rem 2rem;
    color: #6b7280;
    background: linear-gradient(135deg, #fff 0%, #f8fafc 100%);
    border: 2px dashed var(--ab-border);
    border-radius: 20px;
    transition: all 0.3s ease;
  }

  .empty:hover {
    border-color: #0d6efd;
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
  }

  /* Forecast Controls */
  .forecast-controls {
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    border-radius: 16px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    border: 1px solid var(--ab-border);
  }

  .form-select, .form-control {
    border-radius: 12px;
    border: 2px solid var(--ab-border);
    transition: all 0.2s ease;
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(10px);
  }

  .form-select:focus, .form-control:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.1);
    transform: translateY(-1px);
  }

  /* Enhanced Buttons */
  .btn {
    border-radius: 12px;
    font-weight: 600;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }

  .btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: left 0.5s;
  }

  .btn:hover::before {
    left: 100%;
  }

  .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(0,0,0,.15);
  }

  .btn-outline-primary {
    border: 2px solid #0d6efd;
    color: #0d6efd;
    background: rgba(13, 110, 253, 0.05);
  }

  .btn-outline-primary:hover {
    background: var(--primary-gradient);
    border-color: transparent;
    color: white;
  }

  .btn-outline-success {
    border: 2px solid #20c997;
    color: #20c997;
    background: rgba(32, 201, 151, 0.05);
  }

  .btn-outline-success:hover {
    background: var(--success-gradient);
    border-color: transparent;
    color: white;
  }

  /* Forecast Summary */
  .forecast-summary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 16px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
    position: relative;
    overflow: hidden;
  }

  .forecast-summary::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
    animation: float 6s ease-in-out infinite;
  }

  @keyframes float {
    0%, 100% { transform: translate(0, 0) rotate(0deg); }
    50% { transform: translate(-20px, -20px) rotate(180deg); }
  }

  /* Loading Animation */
  .loading {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(255,255,255,.3);
    border-radius: 50%;
    border-top-color: #fff;
    animation: spin 1s ease-in-out infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* Responsive Design */
  @media(max-width: 991px){
    .stack{margin-top:1rem}
    .mini-kpis{grid-template-columns:1fr}
    .forecast-controls .row > div { margin-bottom: 1rem; }
  }

  /* Chart Enhancements */
  .chart-container {
    position: relative;
    height: 300px;
    background: linear-gradient(135deg, #f8fafc 0%, #fff 100%);
    border-radius: 16px;
    padding: 1rem;
  }

  /* Specific styling for Daily Revenue card only */
  .daily-revenue-card .chart-container {
    height: 90px;
    padding: 0.5rem;
  }

  /* Notification Styles */
  .notification {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 9999;
    min-width: 300px;
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0,0,0,.2);
    backdrop-filter: blur(20px);
    animation: slideIn 0.3s ease-out;
  }

  @keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }

  /* Hide Scrollbar */
  body {
    overflow: hidden;
  }

  /* Hide scrollbar for webkit browsers */
  ::-webkit-scrollbar {
    display: none;
  }

  /* Hide scrollbar for Firefox */
  html {
    scrollbar-width: none;
  }

</style>

<div class="row g-4">
  <!-- Left: Chart -->
  <div class="col-lg-8">
    <div class="card kpi-card daily-revenue-card p-2 p-md-3">
      <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-2">
        <h5 class="panel-title mb-0">Daily Revenue (last 60 days) &amp; 7-day Moving Average Forecast</h5>
        <div class="d-flex align-items-center gap-2">
          <span class="pill"><span class="dot dot-blue"></span><span class="muted">Revenue</span></span>
          <span class="pill"><span class="dot dot-green"></span><span class="muted">Forecast (MA7)</span></span>
        </div>
      </div>

      <!-- Enhanced Forecast Controls -->
      <div class="forecast-controls">
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label fw-semibold text-primary">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" class="me-2">
                <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/>
              </svg>
              Forecast Period
            </label>
            <select class="form-select" id="forecastPeriod" onchange="updateForecastChart()">
              <option value="7">üìÖ 7 days</option>
              <option value="14">üìÖ 14 days</option>
              <option value="30">üìÖ 30 days</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label fw-semibold text-primary">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" class="me-2">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
              </svg>
              Moving Average Window
            </label>
            <select class="form-select" id="maWindow" onchange="updateForecastChart()">
              <option value="7">üìä 7 days</option>
              <option value="14">üìä 14 days</option>
              <option value="30">üìä 30 days</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label fw-semibold text-primary">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" class="me-2">
                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
              </svg>
              Actions
            </label>
            <div class="d-flex gap-2">
              <button class="btn btn-primary text-white" id="applyForecast" onclick="updateForecastChart(); return false;" style="background: var(--primary-gradient); border: none;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" class="me-2">
                  <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                </svg>
                Apply
              </button>
              <button class="btn btn-outline-success" id="exportForecast">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" class="me-2">
                  <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                </svg>
                Export
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- quick KPIs computed from the same data (no backend changes) -->
      <div class="mini-kpis mb-3" id="miniKPIs" style="display:none">
        <div class="k">
          <div class="label">Total (period)</div>
          <div class="value num" id="kTotal">‚Äî</div>
        </div>
        <div class="k">
          <div class="label">Average / day</div>
          <div class="value num" id="kAvg">‚Äî</div>
        </div>
        <div class="k">
          <div class="label">Best day</div>
          <div class="value"><span class="num" id="kBestVal">‚Äî</span> <span class="muted" id="kBestWhen"></span></div>
        </div>
      </div>

      <!-- Enhanced Forecast Summary -->
      <div class="forecast-summary" id="forecastSummary" style="display:none">
        <div class="d-flex align-items-center">
          <div class="me-3">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor" class="text-white">
              <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
            </svg>
          </div>
          <div>
            <h6 class="mb-1 fw-bold">üìà Forecast Summary</h6>
            <div class="fs-5 fw-semibold" id="forecastText">Expected revenue for the next 7 days: ‚Ç±0.00</div>
            <small class="opacity-75">Based on moving average analysis</small>
          </div>
        </div>
      </div>

      <div id="chartWrap" class="chart-container">
        <canvas id="histChart" height="40"></canvas>
      </div>
      
      <div id="chartEmpty" class="empty" style="display:none">
        <div class="mb-3">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="currentColor" style="opacity:.6">
            <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
          </svg>
        </div>
        <h5 class="mb-2">üìä No Data Available</h5>
        <p class="mb-0 text-muted">Start making sales to see your forecast data here.</p>
      </div>
    </div>
  </div>

  <!-- Right: Enhanced Analytics -->
  <div class="col-lg-4 stack">
    <div class="card kpi-card p-2 p-md-3">
      <div class="d-flex align-items-center mb-3">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" class="me-2 text-primary">
          <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
        </svg>
        <h5 class="panel-title mb-0">üèÜ Top Sellers (last 60 days)</h5>
      </div>
      {% if top %}
      <div class="table-responsive">
        <table class="table table-sm align-middle table-hover mb-0">
          <thead>
            <tr>
              <th>üì¶ Product</th>
              <th class="text-end">üìä Qty</th>
              <th class="text-end">üí∞ Revenue</th>
            </tr>
          </thead>
          <tbody>
            {% for r in top %}
              <tr>
                <td class="fw-semibold">
                  <div class="d-flex align-items-center">
                    <div class="me-2" style="width: 8px; height: 8px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2);"></div>
                    {{ r.product }}
                  </div>
                </td>
                <td class="text-end num">{{ r.qty }}</td>
                <td class="text-end num fw-bold text-success">‚Ç±{{ r.revenue|floatformat:2 }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
        <div class="empty">
          <div class="mb-3">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="currentColor" style="opacity:.6">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
            </svg>
          </div>
          <h6 class="mb-2">üìà No Sales Data Yet</h6>
          <p class="mb-0 text-muted">Start selling products to see your top performers here.</p>
        </div>
      {% endif %}
    </div>

    <!-- Sales Performance Chart (Last 7 Days) -->
    <div class="card kpi-card p-2 p-md-3 mt-3">
      <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
        <div class="d-flex align-items-center">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" class="me-2 text-success">
            <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/>
          </svg>
          <h5 class="panel-title mb-0">üìä Sales Performance (Last 7 Days)</h5>
        </div>
        <div class="d-flex align-items-center gap-2">
          <span class="pill"><span class="dot dot-blue"></span><span class="muted">Quantity</span></span>
          <span class="pill"><span class="dot dot-green"></span><span class="muted">Revenue</span></span>
        </div>
      </div>
      <div class="chart-container" id="salesPerformanceChartContainer">
      <canvas id="mixChart" height="180"></canvas>
      </div>
      <div id="chartEmptyPerformance" class="empty" style="display:none; margin-top: 1rem;">
        <div class="mb-3">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="currentColor" style="opacity:.6">
            <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/>
          </svg>
        </div>
        <h6 class="mb-2">üìä No Sales Data for Last 7 Days</h6>
        <p class="mb-0 text-muted">Start making sales to see performance data here.</p>
      </div>
    </div>
  </div>
</div>

{# SAFELY embed JSON for JS #}
{{ history|json_script:"hist-json" }}
{{ forecast_points|json_script:"fc-json" }}
{{ top|json_script:"top-json" }}
{{ top_7days|json_script:"top-7days-json" }}

<script>
  // ----- Data -----
  const histData = JSON.parse(document.getElementById('hist-json').textContent || '[]');
  const fcPoints = JSON.parse(document.getElementById('fc-json').textContent || '[]');

  const labels   = histData.map(h => h.date);
  const values   = histData.map(h => Number(h.revenue || 0));
  const fcLabels = fcPoints.map(p => `D+${p.day}`);
  const fcValues = fcPoints.map(p => Number(p.forecast || 0));

  const pesoFmt = new Intl.NumberFormat('en-PH', { style: 'currency', currency: 'PHP' });

  // ----- Empty / KPIs -----
  const hasData = values.length > 0;
  document.getElementById('chartWrap').style.display  = hasData ? '' : 'none';
  document.getElementById('chartEmpty').style.display = hasData ? 'none' : '';
  document.getElementById('miniKPIs').style.display   = hasData ? '' : 'none';
  document.getElementById('forecastSummary').style.display = hasData ? '' : 'none';

  if (hasData) {
    const total = values.reduce((a,b)=>a+b,0);
    const avg   = total / values.length;
    let bestVal = -Infinity, bestIdx = -1;
    values.forEach((v,i)=>{ if (v>bestVal){ bestVal=v; bestIdx=i; } });

    document.getElementById('kTotal').textContent   = pesoFmt.format(total);
    document.getElementById('kAvg').textContent     = pesoFmt.format(avg);
    document.getElementById('kBestVal').textContent = pesoFmt.format(bestVal);
    document.getElementById('kBestWhen').textContent= bestIdx>=0 ? `(${labels[bestIdx]})` : '';

    // Update forecast summary
    const forecastTotal = fcValues.reduce((a,b)=>a+b,0);
    const forecastDays = fcValues.length;
    document.getElementById('forecastText').textContent = 
      `Expected revenue for the next ${forecastDays} days: ${pesoFmt.format(forecastTotal)}`;
  }

  // ----- Main chart -----
  let histChartInstance = null; // Store chart instance globally
  
  if (hasData) {
    const ctx  = document.getElementById('histChart').getContext('2d');
    const grad = ctx.createLinearGradient(0,0,0,220);
    grad.addColorStop(0,'rgba(13,110,253,.22)');
    grad.addColorStop(1,'rgba(13,110,253,0)');

    histChartInstance = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels.concat(fcLabels),
        datasets: [
          {
            label: 'Revenue',
            data: values.concat(Array(fcValues.length).fill(null)),
            borderColor: '#0d6efd',
            backgroundColor: grad,
            fill: true,
            borderWidth: 2,
            tension: .35,
            pointRadius: 0,
            hoverRadius: 3
          },
          {
            label: 'Forecast (MA7)',
            data: Array(values.length).fill(null).concat(fcValues),
            borderColor: '#20c997',
            backgroundColor: '#20c997',
            borderDash: [6,4],
            fill: false,
            borderWidth: 2,
            tension: .25,
            pointRadius: 0,
            hoverRadius: 3
          }
        ]
      },
      options: {
        maintainAspectRatio: false,
        responsive: true,
        interaction: { mode: 'index', intersect: false },
        plugins: {
          legend: { display: false },
          tooltip: {
            padding: 10,
            displayColors: false,
            callbacks: {
              title: items => items?.[0]?.label ?? '',
              label:  ti   => `${ti.dataset.label}: ${pesoFmt.format(ti.raw || 0)}`
            }
          }
        },
        scales: {
          x: { grid: { display:false } },
          y: {
            ticks: { callback: v => pesoFmt.format(v).replace('PHP','‚Ç±') },
            grid: { color:'rgba(0,0,0,.06)', drawBorder:false }
          }
        }
      }
    });
    
    // Setup forecast controls after chart is initialized
    setupForecastControls();
    setTimeout(setupForecastControls, 100);
  } else {
    // Even if no data, still setup controls for future use
    setupForecastControls();
    setTimeout(setupForecastControls, 100);
  }

  // ----- Sales Performance Chart (Bar Chart) - Last 7 Days -----
  (function(){
    const el = document.getElementById('mixChart');
    const emptyEl = document.getElementById('chartEmptyPerformance');
    if (!el) {
      console.error('mixChart element not found');
      return;
    }

    const top7DaysJsonEl = document.getElementById('top-7days-json');
    if (!top7DaysJsonEl) {
      console.error('top-7days-json element not found');
      return;
    }

    const top7DaysData = JSON.parse(top7DaysJsonEl.textContent || '[]');
    console.log('Top 7 days data:', top7DaysData);
    
    // Always show chart, even with empty data
    let productLabels = [];
    let quantityValues = [];
    let revenueValues = [];
    
    const hasData = top7DaysData && top7DaysData.length > 0;
    
    if (hasData) {
      productLabels = top7DaysData.map(t => t.product);
      quantityValues = top7DaysData.map(t => Number(t.qty || 0));
      revenueValues = top7DaysData.map(t => Number(t.revenue || 0));
    } else {
      // If no data, still render chart with placeholder
      productLabels = ['No Sales Data'];
      quantityValues = [0];
      revenueValues = [0];
    }
    
    // Always show chart container - never hide it
    const chartContainer = el.parentElement;
    if (chartContainer) {
      chartContainer.style.display = '';
    }
    
    // Show/hide empty state message below chart
    if (emptyEl) {
      emptyEl.style.display = hasData ? 'none' : '';
    }

    const ctx = el.getContext('2d');
    const grad1 = ctx.createLinearGradient(0,0,0,300);
    grad1.addColorStop(0,'rgba(13,110,253,.8)');
    grad1.addColorStop(1,'rgba(13,110,253,.2)');
    
    const grad2 = ctx.createLinearGradient(0,0,0,300);
    grad2.addColorStop(0,'rgba(32,201,151,.8)');
    grad2.addColorStop(1,'rgba(32,201,151,.2)');

    try {
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: productLabels,
          datasets: [
            {
              label: 'Quantity Sold',
              data: quantityValues,
              backgroundColor: grad1,
              borderColor: '#0d6efd',
              borderWidth: 2,
              borderRadius: 8,
              yAxisID: 'y'
            },
            {
              label: 'Revenue (‚Ç±)',
              data: revenueValues,
              backgroundColor: grad2,
              borderColor: '#20c997',
              borderWidth: 2,
              borderRadius: 8,
              yAxisID: 'y1'
            }
          ]
        },
        options: {
          maintainAspectRatio: false,
          responsive: true,
          interaction: {
            mode: 'index',
            intersect: false
          },
          plugins: {
            legend: { 
              display: false 
            },
            tooltip: {
              padding: 12,
              displayColors: true,
              callbacks: {
                title: (items) => items?.[0]?.label ?? '',
                label: (ti) => {
                  if (ti.datasetIndex === 0) {
                    return `Quantity: ${ti.raw} units`;
                  } else {
                    return `Revenue: ${pesoFmt.format(ti.raw || 0)}`;
                  }
                }
              }
            }
          },
          scales: {
            x: {
              grid: { display: false },
              ticks: {
                font: { size: 11 },
                maxRotation: 45,
                minRotation: 0
              }
            },
            y: {
              type: 'linear',
              display: true,
              position: 'left',
              title: {
                display: true,
                text: 'Quantity Sold',
                color: '#0d6efd',
                font: { weight: 'bold', size: 12 }
              },
              ticks: {
                color: '#0d6efd',
                callback: function(value) {
                  return value;
                },
                beginAtZero: true
              },
              grid: {
                color: 'rgba(13,110,253,.1)',
                drawBorder: false
              }
            },
            y1: {
              type: 'linear',
              display: true,
              position: 'right',
              title: {
                display: true,
                text: 'Revenue (‚Ç±)',
                color: '#20c997',
                font: { weight: 'bold', size: 12 }
              },
              ticks: {
                color: '#20c997',
                callback: function(value) {
                  return pesoFmt.format(value).replace('PHP','‚Ç±');
                },
                beginAtZero: true
              },
              grid: {
                drawOnChartArea: false,
                drawBorder: false
              }
            }
          }
        }
      });
      console.log('Sales performance chart rendered successfully');
    } catch (error) {
      console.error('Error rendering chart:', error);
    }
  })();


  // ----- Interactive Forecast Functions -----
  
  // Moving Average Forecast Function (same logic as backend)
  function calculateMovingAverageForecast(history, horizon, window) {
    if (!history || history.length === 0) {
      return Array(horizon).fill(0.0);
    }
    // Simple avg of last window days
    const lastVals = history.slice(-window).map(h => h.revenue || 0);
    const avg = lastVals.reduce((a, b) => a + b, 0) / Math.max(1, lastVals.length);
    return Array(horizon).fill(Math.round(avg * 100) / 100);
  }

  // Update forecast chart with new parameters
  function updateForecastChart() {
    if (!hasData || !histChartInstance) {
      return;
    }
    
    const forecastPeriodEl = document.getElementById('forecastPeriod');
    const maWindowEl = document.getElementById('maWindow');
    
    if (!forecastPeriodEl || !maWindowEl) {
      return;
    }
    
    const forecastPeriod = parseInt(forecastPeriodEl.value) || 7;
    const maWindow = parseInt(maWindowEl.value) || 7;
    
    // Calculate new forecast
    const newForecastValues = calculateMovingAverageForecast(histData, forecastPeriod, maWindow);
    const newForecastLabels = newForecastValues.map((_, i) => `D+${i+1}`);
    
    // Update chart data
    histChartInstance.data.labels = labels.concat(newForecastLabels);
    histChartInstance.data.datasets[0].data = values.concat(Array(newForecastValues.length).fill(null));
    histChartInstance.data.datasets[1].data = Array(values.length).fill(null).concat(newForecastValues);
    histChartInstance.data.datasets[1].label = `Forecast (MA${maWindow})`;
    
    // Update chart
    histChartInstance.update();
    
    // Update forecast summary
    const forecastTotal = newForecastValues.reduce((a, b) => a + b, 0);
    const forecastTextEl = document.getElementById('forecastText');
    if (forecastTextEl) {
      forecastTextEl.textContent = 
        `Expected revenue for the next ${forecastPeriod} days: ${pesoFmt.format(forecastTotal)}`;
    }
    
    // Update mini KPIs if they exist
    const kTotalEl = document.getElementById('kTotal');
    if (kTotalEl && hasData) {
      const total = values.reduce((a,b)=>a+b,0);
      kTotalEl.textContent = pesoFmt.format(total);
    }
  }
  
  // Expose function globally for debugging
  window.updateForecastChart = updateForecastChart;

  // Setup Forecast Controls - Simplified and reliable
  function setupForecastControls() {
    const forecastPeriodEl = document.getElementById('forecastPeriod');
    const maWindowEl = document.getElementById('maWindow');
    
    if (!forecastPeriodEl || !maWindowEl) {
      setTimeout(setupForecastControls, 100);
      return;
    }
    
    // Remove any existing listeners by cloning
    const newPeriodEl = forecastPeriodEl.cloneNode(true);
    const newWindowEl = maWindowEl.cloneNode(true);
    forecastPeriodEl.parentNode.replaceChild(newPeriodEl, forecastPeriodEl);
    maWindowEl.parentNode.replaceChild(newWindowEl, maWindowEl);
    
    // Add fresh event listeners
    newPeriodEl.addEventListener('change', function() {
      updateForecastChart();
    });
    
    newWindowEl.addEventListener('change', function() {
      updateForecastChart();
    });
    
    // Also set onchange as backup
    newPeriodEl.onchange = updateForecastChart;
    newWindowEl.onchange = updateForecastChart;
  }

  // Apply Forecast Button - Setup on DOM ready
  function setupApplyButton() {
    const applyBtn = document.getElementById('applyForecast');
    if (!applyBtn) {
      setTimeout(setupApplyButton, 100);
      return;
    }
    
    applyBtn.onclick = function(e) {
      e.preventDefault();
      const originalContent = this.innerHTML;
      this.innerHTML = '<div class="loading me-2"></div> Applying...';
      this.disabled = true;
      
      // Update forecast
      updateForecastChart();
      
      // Reset button after update
      setTimeout(() => {
        this.innerHTML = originalContent;
        this.disabled = false;
      }, 500);
    };
  }

  // Export Forecast
  document.getElementById('exportForecast')?.addEventListener('click', function() {
    exportForecastData();
  });

  function exportForecastData() {
    const forecastPeriod = parseInt(document.getElementById('forecastPeriod').value) || 7;
    const maWindow = parseInt(document.getElementById('maWindow').value) || 7;
    const currentForecast = calculateMovingAverageForecast(histData, forecastPeriod, maWindow);
    
    const forecastData = {
      historical: histData,
      forecast: currentForecast.map((val, idx) => ({ day: idx + 1, forecast: val })),
      parameters: {
        forecastPeriod: forecastPeriod,
        movingAverageWindow: maWindow
      },
      summary: {
        totalHistorical: values.reduce((a,b)=>a+b,0),
        totalForecast: currentForecast.reduce((a,b)=>a+b,0),
        averageDaily: values.reduce((a,b)=>a+b,0) / values.length,
        forecastDays: forecastPeriod
      }
    };

    const dataStr = JSON.stringify(forecastData, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    const url = URL.createObjectURL(dataBlob);
    
    const link = document.createElement('a');
    link.href = url;
    link.download = `forecast-${new Date().toISOString().split('T')[0]}.json`;
    link.click();
    
    URL.revokeObjectURL(url);
    showNotification('üì• Forecast data exported successfully!', 'success');
  }

  function showNotification(message, type = 'info') {
    // Create enhanced notification
    const notification = document.createElement('div');
    notification.className = `notification alert alert-${type} alert-dismissible fade show`;
    
    const icons = {
      'success': '‚úÖ',
      'info': '‚ÑπÔ∏è',
      'warning': '‚ö†Ô∏è',
      'danger': '‚ùå'
    };
    
    notification.innerHTML = `
      <div class="d-flex align-items-center">
        <div class="me-3 fs-4">${icons[type] || icons.info}</div>
        <div class="flex-grow-1">
          <div class="fw-semibold">${message}</div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-remove after 4 seconds
    setTimeout(() => {
      if (notification.parentNode) {
        notification.classList.remove('show');
        setTimeout(() => {
          if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
        }, 300);
      }
    }, 4000);
  }

  // Initialize all controls on page load
  function initializeAllControls() {
    setupForecastControls();
    setupApplyButton();
  }
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
      setTimeout(initializeAllControls, 100);
      setTimeout(initializeAllControls, 500);
    });
  } else {
    setTimeout(initializeAllControls, 100);
    setTimeout(initializeAllControls, 500);
  }
  
  // Add keyboard shortcuts
  document.addEventListener('keydown', function(e) {
    // Ctrl+Enter or Ctrl+A to apply forecast
    if (e.ctrlKey && (e.key === 'Enter' || e.key === 'a')) {
      e.preventDefault();
      updateForecastChart();
    }
    // Ctrl+E to export
    if (e.ctrlKey && e.key === 'e') {
      e.preventDefault();
      document.getElementById('exportForecast')?.click();
    }
  });
</script>
{% endblock %}
