{% extends 'core/base.html' %}
{% block content %}

<style>
  :root{
    --ab-border: rgba(16,24,40,.08);
    --ab-soft: rgba(13,110,253,.08);
    --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    --warning-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    --info-gradient: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
  }

  /* Professional Card Design */
  .kpi-card{
    border-radius: 20px;
    border: 1px solid var(--ab-border);
    box-shadow: 0 20px 40px rgba(16,24,40,.08);
    background: linear-gradient(135deg, #fff 0%, #f8fafc 100%);
    backdrop-filter: blur(20px);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }

  .kpi-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: var(--primary-gradient);
  }

  .kpi-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 25px 50px rgba(16,24,40,.12);
  }

  .panel-title{
    font-weight: 800;
    letter-spacing: -0.025em;
    background: var(--primary-gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .muted{color:#6b7280}
  .num{font-variant-numeric:tabular-nums;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}

  /* Enhanced Pills */
  .pill{
    display: inline-flex;
    align-items: center;
    gap: .4rem;
    border: 1px solid var(--ab-border);
    border-radius: 999px;
    padding: .5rem 1rem;
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(10px);
    transition: all 0.2s ease;
    box-shadow: 0 4px 12px rgba(0,0,0,.05);
  }

  .pill:hover {
    transform: translateY(-1px);
    box-shadow: 0 8px 20px rgba(0,0,0,.1);
  }

  .pill .dot{
    width: 12px;
    height: 12px;
    border-radius: 50%;
    box-shadow: 0 2px 4px rgba(0,0,0,.2);
  }
  .dot-blue{background: linear-gradient(135deg, #0d6efd, #4facfe)}
  .dot-green{background: linear-gradient(135deg, #20c997, #4facfe)}

  /* Enhanced Mini KPIs */
  .mini-kpis{
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1rem;
  }

  .mini-kpis .k{
    border: 1px solid var(--ab-border);
    border-radius: 16px;
    padding: 1.25rem 1.5rem;
    background: linear-gradient(135deg, #fff 0%, #f8fafc 100%);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }

  .mini-kpis .k::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: var(--primary-gradient);
  }

  .mini-kpis .k:hover {
    transform: translateY(-3px);
    box-shadow: 0 15px 30px rgba(0,0,0,.1);
  }

  .mini-kpis .k .label{
    font-size: .85rem;
    color: #6b7280;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .mini-kpis .k .value{
    font-size: 1.4rem;
    font-weight: 800;
    margin-top: 0.5rem;
    background: var(--primary-gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  /* Enhanced Table */
  .table thead th{
    color: #6b7280;
    border-bottom-color: var(--ab-border);
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    position: sticky;
    top: 0;
    z-index: 2;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-size: 0.8rem;
  }

  .table-hover>tbody>tr:hover>*{
    background: linear-gradient(135deg, #fafbff 0%, #f1f5f9 100%);
    transform: scale(1.02);
    transition: all 0.2s ease;
  }

  /* Enhanced Empty State */
  .empty{
    text-align: center;
    padding: 3rem 2rem;
    color: #6b7280;
    background: linear-gradient(135deg, #fff 0%, #f8fafc 100%);
    border: 2px dashed var(--ab-border);
    border-radius: 20px;
    transition: all 0.3s ease;
  }

  .empty:hover {
    border-color: #0d6efd;
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
  }

  /* Forecast Controls */
  .forecast-controls {
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    border-radius: 16px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    border: 1px solid var(--ab-border);
  }

  .form-select, .form-control {
    border-radius: 12px;
    border: 2px solid var(--ab-border);
    transition: all 0.2s ease;
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(10px);
  }

  .form-select:focus, .form-control:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.1);
    transform: translateY(-1px);
  }

  /* Enhanced Buttons */
  .btn {
    border-radius: 12px;
    font-weight: 600;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }

  .btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: left 0.5s;
  }

  .btn:hover::before {
    left: 100%;
  }

  .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(0,0,0,.15);
  }

  .btn-outline-primary {
    border: 2px solid #0d6efd;
    color: #0d6efd;
    background: rgba(13, 110, 253, 0.05);
  }

  .btn-outline-primary:hover {
    background: var(--primary-gradient);
    border-color: transparent;
    color: white;
  }

  .btn-outline-success {
    border: 2px solid #20c997;
    color: #20c997;
    background: rgba(32, 201, 151, 0.05);
  }

  .btn-outline-success:hover {
    background: var(--success-gradient);
    border-color: transparent;
    color: white;
  }

  /* Forecast Summary */
  .forecast-summary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 16px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
    position: relative;
    overflow: hidden;
  }

  .forecast-summary::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
    animation: float 6s ease-in-out infinite;
  }

  @keyframes float {
    0%, 100% { transform: translate(0, 0) rotate(0deg); }
    50% { transform: translate(-20px, -20px) rotate(180deg); }
  }

  /* Loading Animation */
  .loading {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(255,255,255,.3);
    border-radius: 50%;
    border-top-color: #fff;
    animation: spin 1s ease-in-out infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* Responsive Design */
  @media(max-width: 991px){
    .stack{margin-top:1rem}
    .mini-kpis{grid-template-columns:1fr}
    .forecast-controls .row > div { margin-bottom: 1rem; }
  }

  /* Chart Enhancements */
  .chart-container {
    position: relative;
    height: 400px;
    background: linear-gradient(135deg, #f8fafc 0%, #fff 100%);
    border-radius: 16px;
    padding: 1rem;
  }

  /* Notification Styles */
  .notification {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 9999;
    min-width: 300px;
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0,0,0,.2);
    backdrop-filter: blur(20px);
    animation: slideIn 0.3s ease-out;
  }

  @keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }

  /* Hide Scrollbar */
  body {
    overflow: hidden;
  }

  /* Hide scrollbar for webkit browsers */
  ::-webkit-scrollbar {
    display: none;
  }

  /* Hide scrollbar for Firefox */
  html {
    scrollbar-width: none;
  }

</style>

<div class="row g-4">
  <!-- Left: Chart -->
  <div class="col-lg-8">
    <div class="card kpi-card p-3 p-md-4">
      <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-2">
        <h5 class="panel-title mb-0">Daily Revenue (last 60 days) &amp; 7-day Moving Average Forecast</h5>
        <div class="d-flex align-items-center gap-2">
          <span class="pill"><span class="dot dot-blue"></span><span class="muted">Revenue</span></span>
          <span class="pill"><span class="dot dot-green"></span><span class="muted">Forecast (MA7)</span></span>
        </div>
      </div>

      <!-- Enhanced Forecast Controls -->
      <div class="forecast-controls">
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label fw-semibold text-primary">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" class="me-2">
                <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/>
              </svg>
              Forecast Period
            </label>
            <select class="form-select" id="forecastPeriod">
              <option value="7">üìÖ 7 days</option>
              <option value="14">üìÖ 14 days</option>
              <option value="30">üìÖ 30 days</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label fw-semibold text-primary">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" class="me-2">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
              </svg>
              Moving Average Window
            </label>
            <select class="form-select" id="maWindow">
              <option value="7">üìä 7 days</option>
              <option value="14">üìä 14 days</option>
              <option value="30">üìä 30 days</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label fw-semibold text-primary">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" class="me-2">
                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
              </svg>
              Actions
            </label>
            <div class="d-flex gap-2">
              <button class="btn btn-outline-primary" id="refreshForecast">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" class="me-2">
                  <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                </svg>
                Refresh
              </button>
              <button class="btn btn-outline-success" id="exportForecast">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" class="me-2">
                  <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                </svg>
                Export
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- quick KPIs computed from the same data (no backend changes) -->
      <div class="mini-kpis mb-3" id="miniKPIs" style="display:none">
        <div class="k">
          <div class="label">Total (period)</div>
          <div class="value num" id="kTotal">‚Äî</div>
        </div>
        <div class="k">
          <div class="label">Average / day</div>
          <div class="value num" id="kAvg">‚Äî</div>
        </div>
        <div class="k">
          <div class="label">Best day</div>
          <div class="value"><span class="num" id="kBestVal">‚Äî</span> <span class="muted" id="kBestWhen"></span></div>
        </div>
      </div>

      <!-- Enhanced Forecast Summary -->
      <div class="forecast-summary" id="forecastSummary" style="display:none">
        <div class="d-flex align-items-center">
          <div class="me-3">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor" class="text-white">
              <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
            </svg>
          </div>
          <div>
            <h6 class="mb-1 fw-bold">üìà Forecast Summary</h6>
            <div class="fs-5 fw-semibold" id="forecastText">Expected revenue for the next 7 days: ‚Ç±0.00</div>
            <small class="opacity-75">Based on moving average analysis</small>
          </div>
        </div>
      </div>

      <div id="chartWrap" class="chart-container">
        <canvas id="histChart" height="120"></canvas>
      </div>
      <div id="chartEmpty" class="empty" style="display:none">
        <div class="mb-3">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="currentColor" style="opacity:.6">
            <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
          </svg>
        </div>
        <h5 class="mb-2">üìä No Data Available</h5>
        <p class="mb-0 text-muted">Start making sales to see your forecast data here.</p>
      </div>
    </div>
  </div>

  <!-- Right: Enhanced Analytics -->
  <div class="col-lg-4 stack">
    <div class="card kpi-card p-3 p-md-4">
      <div class="d-flex align-items-center mb-3">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" class="me-2 text-primary">
          <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
        </svg>
        <h5 class="panel-title mb-0">üèÜ Top Sellers (last 60 days)</h5>
      </div>
      {% if top %}
      <div class="table-responsive">
        <table class="table table-sm align-middle table-hover mb-0">
          <thead>
            <tr>
              <th>üì¶ Product</th>
              <th class="text-end">üìä Qty</th>
              <th class="text-end">üí∞ Revenue</th>
            </tr>
          </thead>
          <tbody>
            {% for r in top %}
              <tr>
                <td class="fw-semibold">
                  <div class="d-flex align-items-center">
                    <div class="me-2" style="width: 8px; height: 8px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2);"></div>
                    {{ r.product }}
                  </div>
                </td>
                <td class="text-end num">{{ r.qty }}</td>
                <td class="text-end num fw-bold text-success">‚Ç±{{ r.revenue|floatformat:2 }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
        <div class="empty">
          <div class="mb-3">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="currentColor" style="opacity:.6">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
            </svg>
          </div>
          <h6 class="mb-2">üìà No Sales Data Yet</h6>
          <p class="mb-0 text-muted">Start selling products to see your top performers here.</p>
        </div>
      {% endif %}
    </div>

    {% if top %}
    <!-- Enhanced Revenue Share Chart -->
    <div class="card kpi-card p-3 p-md-4 mt-3">
      <div class="d-flex align-items-center mb-3">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" class="me-2 text-success">
          <path d="M11 2v20c-5.07-.5-9-4.79-9-10s3.93-9.5 9-10zm2.03 0v8.99H22c-.47-4.74-4.24-8.52-8.97-8.99zm0 11.01V22c4.74-.47 8.5-4.25 8.97-8.99h-8.97z"/>
        </svg>
        <h5 class="panel-title mb-0">ü•ß Revenue Share (top sellers)</h5>
      </div>
      <div class="chart-container">
        <canvas id="mixChart" height="160"></canvas>
      </div>
    </div>
    {% endif %}
  </div>
</div>

{# SAFELY embed JSON for JS #}
{{ history|json_script:"hist-json" }}
{{ forecast_points|json_script:"fc-json" }}
{{ top|json_script:"top-json" }}

<script>
  // ----- Data -----
  const histData = JSON.parse(document.getElementById('hist-json').textContent || '[]');
  const fcPoints = JSON.parse(document.getElementById('fc-json').textContent || '[]');

  const labels   = histData.map(h => h.date);
  const values   = histData.map(h => Number(h.revenue || 0));
  const fcLabels = fcPoints.map(p => `D+${p.day}`);
  const fcValues = fcPoints.map(p => Number(p.forecast || 0));

  const pesoFmt = new Intl.NumberFormat('en-PH', { style: 'currency', currency: 'PHP' });

  // ----- Empty / KPIs -----
  const hasData = values.length > 0;
  document.getElementById('chartWrap').style.display  = hasData ? '' : 'none';
  document.getElementById('chartEmpty').style.display = hasData ? 'none' : '';
  document.getElementById('miniKPIs').style.display   = hasData ? '' : 'none';
  document.getElementById('forecastSummary').style.display = hasData ? '' : 'none';

  if (hasData) {
    const total = values.reduce((a,b)=>a+b,0);
    const avg   = total / values.length;
    let bestVal = -Infinity, bestIdx = -1;
    values.forEach((v,i)=>{ if (v>bestVal){ bestVal=v; bestIdx=i; } });

    document.getElementById('kTotal').textContent   = pesoFmt.format(total);
    document.getElementById('kAvg').textContent     = pesoFmt.format(avg);
    document.getElementById('kBestVal').textContent = pesoFmt.format(bestVal);
    document.getElementById('kBestWhen').textContent= bestIdx>=0 ? `(${labels[bestIdx]})` : '';

    // Update forecast summary
    const forecastTotal = fcValues.reduce((a,b)=>a+b,0);
    const forecastDays = fcValues.length;
    document.getElementById('forecastText').textContent = 
      `Expected revenue for the next ${forecastDays} days: ${pesoFmt.format(forecastTotal)}`;
  }

  // ----- Main chart -----
  if (hasData) {
    const ctx  = document.getElementById('histChart').getContext('2d');
    const grad = ctx.createLinearGradient(0,0,0,220);
    grad.addColorStop(0,'rgba(13,110,253,.22)');
    grad.addColorStop(1,'rgba(13,110,253,0)');

    new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels.concat(fcLabels),
        datasets: [
          {
            label: 'Revenue',
            data: values.concat(Array(fcValues.length).fill(null)),
            borderColor: '#0d6efd',
            backgroundColor: grad,
            fill: true,
            borderWidth: 2,
            tension: .35,
            pointRadius: 0,
            hoverRadius: 3
          },
          {
            label: 'Forecast (MA7)',
            data: Array(values.length).fill(null).concat(fcValues),
            borderColor: '#20c997',
            backgroundColor: '#20c997',
            borderDash: [6,4],
            fill: false,
            borderWidth: 2,
            tension: .25,
            pointRadius: 0,
            hoverRadius: 3
          }
        ]
      },
      options: {
        maintainAspectRatio: false,
        responsive: true,
        interaction: { mode: 'index', intersect: false },
        plugins: {
          legend: { display: false },
          tooltip: {
            padding: 10,
            displayColors: false,
            callbacks: {
              title: items => items?.[0]?.label ?? '',
              label:  ti   => `${ti.dataset.label}: ${pesoFmt.format(ti.raw || 0)}`
            }
          }
        },
        scales: {
          x: { grid: { display:false } },
          y: {
            ticks: { callback: v => pesoFmt.format(v).replace('PHP','‚Ç±') },
            grid: { color:'rgba(0,0,0,.06)', drawBorder:false }
          }
        }
      }
    });
  }

  // ----- NEW: Revenue Share (Doughnut) -----
  (function(){
    const el = document.getElementById('mixChart');
    if (!el) return; // top may be empty, so the card isn't rendered

    const topData = JSON.parse(document.getElementById('top-json').textContent || '[]');
    const mixLabels = topData.map(t => t.product);
    const mixValues = topData.map(t => Number(t.revenue || 0));

    if (!mixValues.length) return;

    // soft palette that matches the UI
    const colors = [
      '#0d6efd','#20c997','#6f42c1','#fd7e14','#dc3545',
      '#198754','#0dcaf0','#6610f2','#ffc107','#6c757d'
    ].slice(0, mixValues.length);

    new Chart(el.getContext('2d'), {
      type: 'doughnut',
      data: {
        labels: mixLabels,
        datasets: [{ data: mixValues, backgroundColor: colors, hoverOffset: 6 }]
      },
      options: {
        plugins: {
          legend: { position: 'bottom' },
          tooltip: {
            callbacks: {
              label: (ti) => `${ti.label}: ${pesoFmt.format(ti.raw || 0)}`
            }
          }
        },
        cutout: '62%'
      }
    });
  })();

  // ----- Interactive Forecast Functions -----
  
  // Forecast Controls
  document.getElementById('forecastPeriod')?.addEventListener('change', function() {
    const days = this.value;
    updateForecastDisplay(days);
  });

  document.getElementById('maWindow')?.addEventListener('change', function() {
    const window = this.value;
    updateMovingAverage(window);
  });

  // Enhanced Refresh Forecast
  document.getElementById('refreshForecast')?.addEventListener('click', function() {
    const originalContent = this.innerHTML;
    this.innerHTML = '<div class="loading me-2"></div> Refreshing...';
    this.disabled = true;
    
    // Add loading animation to the page
    document.body.style.cursor = 'wait';
    
    // Simulate refresh (in real app, this would make an AJAX call)
    setTimeout(() => {
      showNotification('üîÑ Forecast data refreshed successfully!', 'success');
      location.reload();
    }, 1500);
  });

  // Export Forecast
  document.getElementById('exportForecast')?.addEventListener('click', function() {
    exportForecastData();
  });

  // Helper Functions
  function updateForecastDisplay(days) {
    // In a real implementation, this would make an AJAX call to get new forecast data
    console.log(`Updating forecast for ${days} days`);
    // For now, just show a message
    showNotification(`Forecast updated for ${days} days`, 'info');
  }

  function updateMovingAverage(window) {
    // In a real implementation, this would recalculate the moving average
    console.log(`Updating moving average window to ${window} days`);
    showNotification(`Moving average window updated to ${window} days`, 'info');
  }

  function exportForecastData() {
    const forecastData = {
      historical: histData,
      forecast: fcPoints,
      summary: {
        totalHistorical: values.reduce((a,b)=>a+b,0),
        totalForecast: fcValues.reduce((a,b)=>a+b,0),
        averageDaily: values.reduce((a,b)=>a+b,0) / values.length,
        forecastDays: fcValues.length
      }
    };

    const dataStr = JSON.stringify(forecastData, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    const url = URL.createObjectURL(dataBlob);
    
    const link = document.createElement('a');
    link.href = url;
    link.download = `forecast-${new Date().toISOString().split('T')[0]}.json`;
    link.click();
    
    URL.revokeObjectURL(url);
    showNotification('Forecast data exported successfully!', 'success');
  }

  function showNotification(message, type = 'info') {
    // Create enhanced notification
    const notification = document.createElement('div');
    notification.className = `notification alert alert-${type} alert-dismissible fade show`;
    
    const icons = {
      'success': '‚úÖ',
      'info': '‚ÑπÔ∏è',
      'warning': '‚ö†Ô∏è',
      'danger': '‚ùå'
    };
    
    notification.innerHTML = `
      <div class="d-flex align-items-center">
        <div class="me-3 fs-4">${icons[type] || icons.info}</div>
        <div class="flex-grow-1">
          <div class="fw-semibold">${message}</div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-remove after 4 seconds
    setTimeout(() => {
      if (notification.parentNode) {
        notification.classList.remove('show');
        setTimeout(() => {
          if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
        }, 300);
      }
    }, 4000);
  }

  // Add keyboard shortcuts
  document.addEventListener('keydown', function(e) {
    // Ctrl+R to refresh forecast
    if (e.ctrlKey && e.key === 'r') {
      e.preventDefault();
      document.getElementById('refreshForecast')?.click();
    }
    // Ctrl+E to export
    if (e.ctrlKey && e.key === 'e') {
      e.preventDefault();
      document.getElementById('exportForecast')?.click();
    }
  });
</script>
{% endblock %}
