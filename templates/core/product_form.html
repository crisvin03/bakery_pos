{% extends 'core/base.html' %}
{% load static %}
{% block content %}

<style>
  /* Enhanced Product Form Design */
  :root {
    --form-primary: #6366f1;
    --form-secondary: #8b5cf6;
    --form-success: #10b981;
    --form-warning: #f59e0b;
    --form-danger: #ef4444;
    --form-gray-50: #f9fafb;
    --form-gray-100: #f3f4f6;
    --form-gray-200: #e5e7eb;
    --form-gray-300: #d1d5db;
    --form-gray-400: #9ca3af;
    --form-gray-500: #6b7280;
    --form-gray-600: #4b5563;
    --form-gray-700: #374151;
    --form-gray-800: #1f2937;
    --form-gray-900: #111827;
  }

  body {
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    min-height: 100vh;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
  }

  /* Add spacing below sticky navbar */
  .container {
    padding-top: 1rem;
  }

  .form-card { 
    max-width: 700px; 
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    border-radius: 20px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    box-shadow: 0 25px 50px rgba(0, 0, 0, 0.1);
    overflow: hidden;
    position: relative;
  }

  .form-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(135deg, var(--form-primary), var(--form-secondary));
  }


  .thumb-lg {
    width: 120px; 
    height: 120px; 
    border-radius: 16px; 
    object-fit: cover;
    background: linear-gradient(135deg, var(--form-gray-50), var(--form-gray-100));
    border: 2px solid var(--form-gray-200);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
  }

  .thumb-lg:hover {
    transform: scale(1.05);
    box-shadow: 0 12px 35px rgba(0, 0, 0, 0.15);
  }

  .image-upload-area {
    background: linear-gradient(135deg, var(--form-gray-50), white);
    border: 2px dashed var(--form-gray-300);
    border-radius: 16px;
    padding: 2rem;
    text-align: center;
    transition: all 0.3s ease;
    cursor: pointer;
    width: 100%;
  }
  
  .image-upload-area.mt-2 {
    padding: 1rem;
    border-radius: 12px;
  }

  .image-upload-area:hover {
    border-color: var(--form-primary);
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.05), rgba(139, 92, 246, 0.05));
  }

  .upload-icon {
    width: 48px;
    height: 48px;
    color: var(--form-gray-400);
    margin-bottom: 1rem;
    transition: all 0.3s ease;
  }
  
  .image-upload-area.mt-2 .upload-icon {
    width: 32px;
    height: 32px;
    margin-bottom: 0.5rem;
  }

  .upload-text {
    color: var(--form-gray-500);
    font-size: 0.9rem;
    margin-bottom: 0.5rem;
    white-space: nowrap;
  }

  .upload-hint {
    color: var(--form-gray-400);
    font-size: 0.8rem;
  }

  .section-title {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--form-gray-800);
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .section-title::before {
    content: '';
    width: 4px;
    height: 24px;
    background: linear-gradient(135deg, var(--form-primary), var(--form-secondary));
    border-radius: 2px;
  }

  .form-section {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.8), rgba(248, 250, 252, 0.8));
    border-radius: 16px;
    padding: 0.75rem;
    margin-bottom: 1rem;
    border: 1px solid var(--form-gray-200);
    height: 100%;
    display: flex;
    flex-direction: column;
  }

  .form-control {
    border: 2px solid var(--form-gray-200);
    border-radius: 12px;
    padding: 0.75rem 1rem;
    font-weight: 500;
    transition: all 0.3s ease;
    background: rgba(255, 255, 255, 0.9);
  }

  .form-control:focus {
    border-color: var(--form-primary);
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    transform: translateY(-1px);
  }

  .form-label {
    font-weight: 600;
    color: var(--form-gray-700);
    margin-bottom: 0.5rem;
    font-size: 0.95rem;
  }

  .btn-primary {
    background: linear-gradient(135deg, var(--form-primary), var(--form-secondary));
    border: none;
    color: white;
    font-weight: 600;
    padding: 0.75rem 2rem;
    border-radius: 12px;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
  }

  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4);
    color: white;
  }

  .btn-outline-secondary {
    border: 2px solid var(--form-gray-300);
    color: var(--form-gray-700);
    background: white;
    font-weight: 600;
    padding: 0.75rem 2rem;
    border-radius: 12px;
    transition: all 0.3s ease;
  }

  .btn-outline-secondary:hover {
    background: var(--form-gray-50);
    border-color: var(--form-gray-400);
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    color: var(--form-gray-800);
  }

  .form-check-input {
    width: 1.25rem;
    height: 1.25rem;
    border-radius: 6px;
    border: 2px solid var(--form-gray-300);
    transition: all 0.3s ease;
  }

  .form-check-input:checked {
    background-color: var(--form-primary);
    border-color: var(--form-primary);
  }

  .form-check-label {
    font-weight: 500;
    color: var(--form-gray-700);
    margin-left: 0.5rem;
  }

  /* Hide the link, "Change:" label, checkbox, and "Currently:" text in ClearableFileInput */
  label[for*="clear"] {
    display: none !important;
  }
  
  /* Hide the clear checkbox */
  input[type="checkbox"][id*="clear"],
  input[type="checkbox"][name*="clear"] {
    display: none !important;
  }
  
  /* Hide any "Change:" text that might appear */
  .form-control + label,
  #id_image + label {
    display: none !important;
  }

  /* Responsive Design */
  @media (max-width: 768px) {
    .form-card {
      margin: 1rem;
      max-width: none;
    }
    
    .thumb-lg {
      width: 120px;
      height: 120px;
    }
  }
</style>

<div class="card form-card mx-auto">
  <div class="card-body p-3 p-md-4">

    <form method="post" enctype="multipart/form-data" novalidate data-is-new="{% if not form.instance.pk %}true{% else %}false{% endif %}">
      {% csrf_token %}

      <div class="row g-3">
        <!-- Image Upload Section -->
        <div class="col-md-3">
          <div class="form-section">
            <h3 class="section-title">üì∏ Product Image</h3>
            <div class="d-flex flex-column align-items-center gap-2">
            {% if form.instance.image %}
                <img id="preview" src="{{ form.instance.image.url }}" class="thumb-lg" alt="Product Preview" style="cursor: pointer;" title="Click to change image">
            {% else %}
                <img id="preview" src="" class="thumb-lg d-none" alt="Product Preview" style="cursor: pointer;" title="Click to change image">
            {% endif %}

              {{ form.image }}
              
            <div id="placeholder" class="image-upload-area {% if form.instance.image %}mt-2{% endif %}">
              <svg class="upload-icon" viewBox="0 0 24 24" fill="currentColor">
                <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
              </svg>
              <div class="upload-text">{% if form.instance.image %}Change Image{% else %}Click to upload{% endif %}</div>
              <div class="upload-hint">PNG/JPG up to 5MB</div>
            </div>
              
              <div class="form-text text-center d-none">
                <small class="text-muted">PNG, JPG, JPEG</small>
              </div>
            </div>
          </div>
        </div>

        <!-- Product Details Section -->
        <div class="col-md-9">
          <div class="form-section">
            <h3 class="section-title">üìù Product Details</h3>
            
            <div class="row g-2">
              <div class="col-md-6">
                <label class="form-label">Product Name</label>
            {{ form.name }}
          </div>

              <div class="col-md-3">
                <label class="form-label">Price (‚Ç±)</label>
            {{ form.price }}
          </div>

              <div class="col-md-3">
                <label class="form-label"> Stock</label>
            {{ form.stock }}
          </div>
 
              <div class="col-md-3">
                <label class="form-label">Expiration Date</label>
            {{ form.expiration_date }}
          </div>

              <div class="col-md-3">
                <label class="form-label">Status</label>
                <div class="form-check form-switch">
                  {{ form.is_active }}
                  <label class="form-check-label">Active</label>
                </div>
              </div>

              <div class="col-12">
            <label class="form-label">Ingredients</label>
            {{ form.ingredients }}
          </div>
          </div>

            <!-- Action Buttons -->
            <div class="d-flex gap-2 justify-content-end mt-auto">
            <a class="btn btn-outline-secondary" href="/products/">Cancel</a>
              <button class="btn btn-primary" type="submit">
                {% if form.instance.pk %}Update Product{% else %}Create Product{% endif %}
              </button>
            </div>
          </div>
        </div>
      </div>
    </form>
  </div>
</div>

<script>
  // Enhanced Product Form Functionality
  document.addEventListener('DOMContentLoaded', function() {
    // Hide the link, "Change:" label, and "Currently:" text from ClearableFileInput
    const imageInput = document.getElementById("id_image");
    if (imageInput) {
      // Find the parent container
      const imageInputContainer = imageInput.closest('div') || imageInput.parentElement;
      if (imageInputContainer) {
        // Hide the link
        const links = imageInputContainer.querySelectorAll('a[href*="/media/"]');
        links.forEach(link => {
          link.style.display = 'none';
        });
        
        // Hide the "Change:" label
        const changeLabels = imageInputContainer.querySelectorAll('label[for*="clear"]');
        changeLabels.forEach(label => {
          label.style.display = 'none';
        });
        
        // Hide the clear checkbox
        const clearCheckboxes = imageInputContainer.querySelectorAll('input[type="checkbox"][id*="clear"], input[type="checkbox"][name*="clear"]');
        clearCheckboxes.forEach(checkbox => {
          checkbox.style.display = 'none';
        });
        
        // Find and hide/remove "Currently:" text
        // Check all elements in the container
        const allElements = imageInputContainer.querySelectorAll('*');
        allElements.forEach(el => {
          const text = el.textContent || '';
          // If element only contains "Currently:" or starts with it
          if (text.trim() === 'Currently:' || text.trim().match(/^Currently:\s*$/)) {
            el.style.display = 'none';
          } else if (text.includes('Currently:')) {
            // Replace "Currently:" in the text
            el.textContent = text.replace(/Currently:\s*/g, '');
          }
        });
        
        // Check text nodes directly (for text not in elements)
        const walker = document.createTreeWalker(
          imageInputContainer,
          NodeFilter.SHOW_TEXT,
          null,
          false
        );
        let node;
        while (node = walker.nextNode()) {
          if (node.textContent && node.textContent.includes('Currently:')) {
            node.textContent = node.textContent.replace(/Currently:\s*/g, '');
          }
        }
        
        // Check siblings of the input
        let nextSibling = imageInput.nextElementSibling;
        while (nextSibling) {
          if (nextSibling.tagName === 'LABEL' && nextSibling.textContent.includes('Change')) {
            nextSibling.style.display = 'none';
          }
          // Hide elements that only contain "Currently:"
          if (nextSibling.textContent && nextSibling.textContent.trim() === 'Currently:') {
            nextSibling.style.display = 'none';
          }
          nextSibling = nextSibling.nextElementSibling;
        }
      }
      
      // Also check the parent of the input's parent (Django wraps things)
      const parentContainer = imageInput.parentElement?.parentElement;
      if (parentContainer) {
        const currentlyElements = Array.from(parentContainer.querySelectorAll('*')).filter(el => {
          return el.textContent && el.textContent.trim() === 'Currently:';
        });
        currentlyElements.forEach(el => {
          el.style.display = 'none';
        });
      }
    }
    
    // Image upload with enhanced preview
    const input = document.getElementById("id_image");
    const preview = document.getElementById("preview");
    const placeholder = document.getElementById("placeholder");
    const uploadArea = document.querySelector('.image-upload-area');

    // Hide the default file input
    if (input) {
      input.style.display = 'none';
    }

    if (input && preview) {
      // Click to upload functionality
      if (uploadArea) {
        uploadArea.addEventListener('click', () => input.click());
      }
      
      // Also allow clicking on preview to change image (always, even if visible)
      if (preview) {
        preview.style.cursor = 'pointer';
        preview.addEventListener('click', () => input.click());
      }

      // Function to update image preview
      function updateImagePreview(file) {
        if (!file) return;

        // Validate file type
        const validTypes = ['image/jpeg', 'image/jpg', 'image/png'];
        if (!validTypes.includes(file.type)) {
          alert('Please select a valid image file (PNG, JPG, JPEG)');
          input.value = ''; // Clear the input
          return;
        }

        // Validate file size (5MB limit)
        if (file.size > 5 * 1024 * 1024) {
          alert('File size must be less than 5MB');
          input.value = ''; // Clear the input
          return;
        }

        // Create preview URL
        const url = URL.createObjectURL(file);
        preview.src = url;
        preview.classList.remove("d-none");
        // Keep upload area visible but update text
        if (placeholder) {
          const uploadText = placeholder.querySelector('.upload-text');
          if (uploadText) {
            uploadText.textContent = 'Change Image';
          }
        }
        
        // Add success animation
        preview.style.transform = 'scale(1.1)';
        setTimeout(() => {
          preview.style.transform = 'scale(1)';
        }, 200);
        
        // Make preview clickable to change image
        preview.style.cursor = 'pointer';
      }

      // Handle file selection
      input.addEventListener("change", function (e) {
        const file = e.target.files && e.target.files[0];
        updateImagePreview(file);
      });
    }

    // Form validation and enhancement
    const productForm = document.querySelector('form');
    const nameInput = document.getElementById('id_name');
    const priceInput = document.getElementById('id_price');
    const ingredientsInput = document.getElementById('id_ingredients');

    // Real-time validation
    if (nameInput) {
      nameInput.addEventListener('input', function() {
        if (this.value.length > 0) {
          this.style.borderColor = '#10b981';
        } else {
          this.style.borderColor = '';
        }
      });
    }

    if (priceInput) {
      priceInput.addEventListener('input', function() {
        const value = parseFloat(this.value);
        if (value > 0) {
          this.style.borderColor = '#10b981';
        } else {
          this.style.borderColor = '';
        }
      });
    }

    // Form submission with loading state
    if (productForm) {
      productForm.addEventListener('submit', function(e) {
        const submitBtn = productForm.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        
        // Add loading state
        submitBtn.innerHTML = `
          <div class="spinner-border spinner-border-sm me-2" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          {% if form.instance.pk %}Updating...{% else %}Creating...{% endif %}
        `;
        submitBtn.disabled = true;
        
        // Re-enable after 3 seconds (in case of slow response)
        setTimeout(() => {
          submitBtn.innerHTML = originalText;
          submitBtn.disabled = false;
        }, 3000);
      });
    }

    // Auto-save draft functionality (localStorage)
    const formData = {
      name: nameInput?.value || '',
      price: priceInput?.value || '',
      ingredients: ingredientsInput?.value || ''
    };

    // Save to localStorage on input change
    [nameInput, priceInput, ingredientsInput].forEach(input => {
      if (input) {
        input.addEventListener('input', function() {
          const data = {
            name: nameInput?.value || '',
            price: priceInput?.value || '',
            ingredients: ingredientsInput?.value || ''
          };
          localStorage.setItem('productFormDraft', JSON.stringify(data));
        });
      }
    });

    // Load draft on page load (only for new products)
    const isNewProduct = productForm.dataset.isNew === 'true';
    if (isNewProduct) {
      const savedDraft = localStorage.getItem('productFormDraft');
      if (savedDraft) {
        try {
          const draft = JSON.parse(savedDraft);
          if (nameInput && draft.name) nameInput.value = draft.name;
          if (priceInput && draft.price) priceInput.value = draft.price;
          if (ingredientsInput && draft.ingredients) ingredientsInput.value = draft.ingredients;
        } catch (e) {
          console.log('Could not load draft data');
        }
      }
    } else {
      // Clear draft for existing products
      localStorage.removeItem('productFormDraft');
    }

    // Clear draft on successful submission
    if (productForm) {
      productForm.addEventListener('submit', function() {
        localStorage.removeItem('productFormDraft');
      });
    }

    // Enhanced tooltips and help text
    const helpTexts = {
      name: 'Choose a descriptive name that customers will recognize',
      price: 'Set a competitive price that covers your costs and desired profit',
      ingredients: 'List key ingredients to help customers with allergies or preferences'
    };

    // Add help text on focus
    [nameInput, priceInput, ingredientsInput].forEach(input => {
      if (input) {
        input.addEventListener('focus', function() {
          const fieldName = this.id.replace('id_', '');
          const helpText = helpTexts[fieldName];
          if (helpText) {
            // Create or update help tooltip
            let tooltip = document.getElementById('help-tooltip');
            if (!tooltip) {
              tooltip = document.createElement('div');
              tooltip.id = 'help-tooltip';
              tooltip.className = 'form-text text-primary fw-semibold';
              tooltip.style.position = 'absolute';
              tooltip.style.zIndex = '1000';
              document.body.appendChild(tooltip);
            }
            tooltip.textContent = helpText;
            tooltip.style.display = 'block';
          }
        });

        input.addEventListener('blur', function() {
          const tooltip = document.getElementById('help-tooltip');
          if (tooltip) {
            tooltip.style.display = 'none';
          }
        });
      }
    });
  });
</script>
{% endblock %}
