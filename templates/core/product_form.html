{% extends 'core/base.html' %}
{% load static %}
{% block content %}

<style>
  .form-card { max-width: 860px; }
  .thumb-lg {
    width: 140px; height: 140px; border-radius: 16px; object-fit: cover;
    background:#f1f3f5; border:1px solid rgba(0,0,0,.06);
  }
  .btn-honey { background:#0d6efd; border-color:#0d6efd; color:#fff; }
  .btn-honey:hover { filter:brightness(.95); color:#fff; }
</style>

<div class="card shadow-sm form-card mx-auto">
  <div class="card-body p-4 p-md-5">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2 class="h4 m-0">{{ form.instance.pk|yesno:"Edit Product,New Product" }}</h2>
      <a href="/products/" class="btn btn-outline-secondary">Back</a>
    </div>

    <form method="post" enctype="multipart/form-data" novalidate>
      {% csrf_token %}

      <div class="row g-4">
        <div class="col-md-4">
          <label class="form-label fw-semibold">Product image</label>
          <div class="d-flex flex-column align-items-start gap-2">
            {% if form.instance.image %}
              <img id="preview" src="{{ form.instance.image.url }}" class="thumb-lg" alt="Preview">
            {% else %}
              <img id="preview" src="" class="thumb-lg d-none" alt="Preview">
              <div id="placeholder" class="thumb-lg d-flex align-items-center justify-content-center">
                <span class="text-secondary small">No image</span>
              </div>
            {% endif %}

            {{ form.image }}  {# <-- fix: render field directly, no as_widget filter #}
            <div class="form-text">PNG/JPG up to ~5MB.</div>
          </div>
        </div>

        <div class="col-md-8">
          <div class="mb-3">
            <label class="form-label">Name</label>
            {{ form.name }}
          </div>
          <div class="mb-3">
            <label class="form-label">Price</label>
            {{ form.price }}
          </div>
          <div class="mb-3">
            <label class="form-label">Ingredients</label>
            {{ form.ingredients }}
          </div>
          <div class="form-check mb-4">
            {{ form.is_active }}
            <label class="form-check-label">Active</label>
          </div>

          <div class="d-flex gap-2">
            <button class="btn btn-honey" type="submit">Save</button>
            <a class="btn btn-outline-secondary" href="/products/">Cancel</a>
          </div>
        </div>
      </div>
    </form>
  </div>
</div>

<script>
  // Live preview for new image selection
  (function () {
    const input = document.getElementById("id_image");
    if (!input) return;
    const preview = document.getElementById("preview");
    const placeholder = document.getElementById("placeholder");

    input.addEventListener("change", function (e) {
      const file = e.target.files && e.target.files[0];
      if (!file) return;
      const url = URL.createObjectURL(file);
      preview.src = url;
      preview.classList.remove("d-none");
      if (placeholder) placeholder.classList.add("d-none");
    });
  })();
</script>
{% endblock %}
